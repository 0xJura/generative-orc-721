

<!--
    source based on fiddle by @jokie
       see https://jsfiddle.net/uf95w2j4/7/
-->


<style>

.container {
    max-width: 800px;
    margin: auto;
    padding: 10px;
    font-family: Arial, sans-serif;
}

.instructions {
    background-color: #f9f9f9;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.instructions img {
    max-width: 100px;
    display: block;
    margin-top: 10px;
}

.input-fields {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    margin-bottom: 20px;
}

.input-fields label, .input-fields input {
    margin-bottom: 10px;
}

#spritesheet {
  display: grid;
  margin: auto;
  transform: scale(1);
  transform-origin: 0 0;
}


#canvas {
  filter: blur(.0px);
  border: 2px solid #ccc;
  margin: 10px;
  text-align: center;
  background-color: #eee;
}

#cleardiv {
  margin-bottom:20px;
  text-align:center;
}

.footer {
    text-align: center;
    color: #777;
    border-top: 1px solid #ccc;
    padding-top: 20px;
}

button {
    display: inline-block;
    padding: 15px 30px;
    font-size: 18px;
    text-align: center;
    cursor: pointer;
    outline: none;
    color: #fff;
    background-color: #44f;
    border: none;
    border-radius: 5px;
    transition: background-color 0.3s ease;
}

a[disabled] {
  color: #ccc;
  cursor: not-allowed;
  pointer-events: none;
  text-decoration: none;
}
a:not([disabled]) {
  color: #00f;
  cursor: pointer;
  text-decoration: underline;
}
</style>


<div class="container">
  <h1>Generative ORC-721 Previewer</h1>
  <div class="instructions">
      <p>Directions:</p>
      <ol>
          <li>Upload the sprite map from the inscription. (an example diypunks sprite map) <img src="https://cdn.discordapp.com/attachments/900856159211257889/1113607517512155136/cf5df319bbe23fa3d012e5ee0810700c8e82aebff41164246f0d87d7b60a9903i0.png" /> </li>
          <li>Specify the number of rows and columns of sprites. (in the above case, its 10 columns and 6 rows)</li>
          <li>Click on the sprite image to construct your mint inscription</li>
          <li>Press clear to start over.</li>
          <li>When you're happy, use the attribute list generated.</li>
      </ol>
  </div>
  <div class="input-fields">
      <label for="spriteMap">Upload Sprite Map (Image):</label>
      <input id="spriteMap" type="file" accept="image/png, image/jpeg">
  </div>
  <div class="input-fields">
      <label for="spriteColumns">How many columns does it have? (usually 10)</label>
      <input id="spriteColumns" type="number">
  </div>
  <div class="input-fields">

      <label for="spriteRows">How many rows does it have?</label>
      <input id="spriteRows" type="number">
  </div>
  <div id="spritesheet"></div>
  <div style="text-align:center;">
    <canvas id="canvas" width="240" height="240"></canvas>
    <p id="output"></p>

  </div>
  <div id="cleardiv">
      <button id="clear">Clear Canvas</button>
      <a id="download" href="#" disabled>Download</a>
  </div>


  <div class="footer">
      DIY Punks is a project by geraldb.
      Learn more on the <a href="https://discord.gg/swBWd827qM">Ordinal Punks discord</a> (in the #generative-orc-721 channel)
      and the <a href="https://github.com/ordbase/generative-orc-721">generative-orc-721 github</a>
      <p>This previewer adopted from a fiddle written by Jokie.
         If you're not 100% satisfied I will refund the full amount you paid me to use this tool. </p>
  </div>
</div>


<!-- note: requires jquery 3.4.1 -->
<script scr="https://code.jquery.com/jquery-3.4.1.min.js"></script>

<script>

let canvas = document.getElementById('canvas');
canvas.width = 240;
canvas.height = 240;
let ctx = canvas.getContext('2d');
ctx.imageSmoothingEnabled = false; // Disable image smoothing
let img = new Image();
let spriteColumnsInput = document.getElementById('spriteColumns');
let spriteRowsInput = document.getElementById('spriteRows');
let output = document.getElementById('output');
let selectedSprites = [];
let scaleFactor = 10;

document.getElementById('spriteMap').addEventListener('change', function(evt) {
    if (evt.target.files.length > 0) {
        let file = evt.target.files[0];
        let reader = new FileReader();
        reader.onloadend = function() {
            img.src = reader.result;
            img.onload();
        }
        reader.readAsDataURL(file);
    }
});

img.onload = function() {
		//estimate it by assuming the width is 10 columns if no values are specified
    let spriteColumns = spriteColumnsInput.value ? parseInt(spriteColumnsInput.value) : 10;
		let spriteRows = spriteRowsInput.value ? parseInt(spriteRowsInput.value) : Math.round(img.height / (img.width / spriteColumns));

    // Set the input fields to the calculated values
		spriteColumnsInput.value = spriteColumns;
		spriteRowsInput.value = spriteRows;

    let spriteWidth = img.width / spriteColumns;
    let spriteHeight = img.height / spriteRows;
    let numberOfSprites = spriteColumns * spriteRows;

    let spritesheet = document.getElementById('spritesheet');
    spritesheet.innerHTML = ''; // Clear the spritesheet before adding new sprites

    // Dynamically set the grid and background properties
    spritesheet.style.gridTemplateColumns = `repeat(${spriteColumns}, ${spriteWidth}px)`;
    spritesheet.style.gridTemplateRows = `repeat(${spriteRows}, ${spriteHeight}px)`;
    spritesheet.style.width = `${img.width}px`;
    spritesheet.style.height = `${img.height}px`;
    spritesheet.style.background = `url(${img.src})`;

    for(let i = 0; i < numberOfSprites; i++) {
        let sprite = document.createElement('div');

        sprite.className = 'sprite';
        sprite.style.width = `${spriteWidth}px`;
        sprite.style.height = `${spriteHeight}px`;
        sprite.style.backgroundPosition = `-${(i % spriteColumns) * spriteWidth}px -${Math.floor(i / spriteColumns) * spriteHeight}px`;
		    sprite.title = i;
        sprite.addEventListener('click', () => {
            let row = Math.floor(i / spriteColumns);
            let col = i % spriteColumns;

            ctx.drawImage(img, col * spriteWidth, row * spriteHeight, spriteWidth, spriteHeight, 0, 0, canvas.width, canvas.height);
            selectedSprites.push(i);
            output.textContent = '"g":[' + selectedSprites.join(',') + ']';
            document.getElementById('download').removeAttribute('disabled');
        });

        spritesheet.appendChild(sprite);
    }
};

spriteColumnsInput.addEventListener('input', img.onload);
spriteRowsInput.addEventListener('input', img.onload);

document.getElementById('clear').addEventListener('click', () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    selectedSprites = [];
    output.textContent = '';
    document.getElementById('download').setAttribute('disabled', 'true');
});

document.getElementById('download').addEventListener('click', function() {
    this.href = canvas.toDataURL('image/png');
    this.download = 'my-orc-721.png';
});

</script>
